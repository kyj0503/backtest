# 백테스트 로직 아키텍처

## 개요

본 시스템의 백테스트 로직은 `backtesting.py` 라이브러리를 핵심 엔진으로 사용하되, 실제 서비스 요구사항에 맞춘 다양한 기능을 래핑하여 구현되었습니다. 핵심 목표는 다양한 금융 상품, 통화, 투자 전략을 일관된 방식으로 테스트하고 분석하는 것입니다.

## 아키텍처 흐름

백테스트 실행의 전체적인 흐름은 다음과 같습니다.

```
API 요청 (Request)
    |
    v
Service Layer (`backtest_service`, `portfolio_service`)
    |  1. 입력값 검증
    |  2. 데이터 로드 요청
    |
    v
Data Repository (`data_repository`)
    |  1. 인메모리 캐시 확인
    |  2. DB 캐시 확인 (MySQL)
    |  3. yfinance API 호출 (캐시 없음)
    |
    v
Backtest Engine (`backtest_engine.py`)
    |  1. **통화 변환 (모든 자산을 USD로)**
    |  2. 전략 클래스 동적 생성 (파라미터 적용)
    |  3. `backtesting.py` 라이브러리 호출
    |  4. 백테스트 실행 (`bt.run()`)
    |
    v
결과 직렬화 및 반환 (Response)
```

## `backtesting.py`의 역할

`backtesting.py`는 순수 백테스팅 실행 엔진으로서 다음과 같은 핵심 기능을 담당합니다.

- **이벤트 기반 시뮬레이션**: 과거 가격 데이터를 순회하며 각 시점(봉)마다 `strategy.next()` 메서드를 호출합니다.
- **전략 실행**: `Strategy` 클래스의 `init()`과 `next()` 메서드를 실행하여 매매 로직을 처리합니다.
- **계좌 관리**: 현금, 포지션, 자산 가치(equity)를 내부적으로 관리하고 업데이트합니다.
- **기본 통계 계산**: 거래 내역, 수익률, 승률 등 기본적인 통계 지표를 계산하여 반환합니다.

본 프로젝트는 `backtesting.py`를 직접 수정하지 않고, 래퍼 클래스(`BacktestEngine`)를 통해 기능을 확장하고 제어합니다.

## 커스텀 구현 로직

`backtesting.py`의 기본 기능 외에, 본 시스템은 다음과 같은 핵심 로직을 자체적으로 구현했습니다.

### 1. `BacktestEngine`: 핵심 래퍼 클래스

`app/services/backtest_engine.py`에 위치한 `BacktestEngine`은 백테스트의 전 과정을 오케스트레이션합니다.

- **통화 변환**:
  - **가장 중요한 커스텀 로직 중 하나입니다.**
  - 백테스트 실행 전, `_convert_to_usd` 메서드를 통해 모든 자산의 가격 데이터를 USD로 변환합니다.
  - 이를 통해 다른 통화(KRW, JPY, EUR 등)로 거래되는 자산도 동일한 기준에서 비교하고 합산할 수 있습니다.
  - 환율 데이터는 주가 데이터와 마찬가지로 캐시 우선 정책으로 조회됩니다.

- **동적 전략 생성**:
  - 사용자가 API를 통해 전달한 전략 파라미터(예: `sma_short=15`)를 `_build_strategy` 메서드에서 동적으로 적용합니다.
  - 원본 전략 클래스를 상속받아 파라미터가 오버라이드된 새로운 클래스를 즉석에서 생성하여 백테스트에 사용합니다.

- **데이터 관리**:
  - `_get_price_data` 메서드를 통해 `DataRepository`에 데이터 조회를 위임하여 캐싱 정책을 활용합니다.
  - `asyncio.to_thread()`를 사용하여 동기적인 데이터 조회 라이브러리(yfinance, SQLAlchemy) 호출 시 발생할 수 있는 레이스 컨디션을 방지합니다.

- **결과 표준화**:
  - `backtesting.py`가 반환하는 `pd.Series` 형태의 결과를 `BacktestResult` Pydantic 스키마에 맞춰 표준화된 JSON 객체로 변환합니다.
  - 거래 로그, 일별 자산 가치(equity curve) 등을 추출하고 가공합니다.

### 2. `PortfolioService`: 포트폴리오 로직

`app/services/portfolio_service.py`는 여러 자산을 조합하는 포트폴리오 백테스트의 핵심 로직을 담고 있습니다.

- **Buy & Hold 시뮬레이션**:
  - 포트폴리오의 투자 전략이 'Buy & Hold'인 경우, `backtesting.py`를 사용하지 않고 자체적으로 수익률을 계산합니다.
  - `calculate_dca_portfolio_returns` 메서드가 이 역할을 수행하며, 다음과 같은 복잡한 로직을 처리합니다.
    - **DCA (분할 매수)**: 정해진 주기(매주, 매월 등)와 횟수에 따라 자동으로 추가 매수를 시뮬레이션합니다.
    - **리밸런싱**: 정해진 주기마다 각 자산의 비중이 목표 비중을 유지하도록 매매를 시뮬레이션합니다.
    - **상장폐지 감지**: 특정 기간 이상 가격 데이터가 없으면 해당 종목을 상장폐지로 간주하고, 리밸런싱 시 비중을 동적으로 재계산합니다.

- **전략 기반 포트폴리오**:
  - 포트폴리오에 특정 기술적 분석 전략(예: SMA 교차)을 적용할 경우, 각 자산에 대해 `BacktestEngine`을 개별적으로 실행합니다.
  - 각 자산의 백테스트 결과를 투자 비중에 따라 가중 평균하여 포트폴리오 전체의 성과를 계산합니다.

## 결론

본 시스템은 `backtesting.py`를 순수한 계산 엔진으로 활용하면서, 그 앞단에 `BacktestEngine`과 `PortfolioService`라는 강력한 래퍼를 두어 데이터 준비, 통화 변환, 복잡한 포트폴리오 전략(DCA, 리밸런싱) 등 실제 서비스에 필요한 기능들을 구현한 아키텍처를 가집니다. 이를 통해 라이브러리의 한계를 극복하고 유연하고 확장 가능한 백테스팅 환경을 구축했습니다.
