================================================================================
QUICK REFERENCE: calculate_dca_portfolio_returns() REFACTORING
================================================================================

LOCATION: backtest_be_fast/app/services/portfolio_service.py (lines 86-709)
CURRENT SIZE: 625 lines (single function)
CURRENT COMPLEXITY: Very High (cyclomatic complexity 10+, nesting depth 4)

================================================================================
8 EXTRACTION CANDIDATES (IN RECOMMENDED ORDER)
================================================================================

1. initialize_portfolio_state()
   Lines: 191-213 (23 lines)
   Complexity: LOW ✓
   Purpose: Set up all tracking variables
   Inputs: stock_amounts, cash_amount, amounts
   Outputs: Dict with state variables
   Dependencies: None
   Extract First: Yes (pure setup, no dependencies)

2. calculate_adjusted_rebalance_weights()
   Lines: 428-458 (31 lines)
   Complexity: LOW-MEDIUM ✓
   Purpose: Adjust target weights for delisted stocks
   Inputs: target_weights, delisted_stocks, dca_info
   Outputs: adjusted_target_weights
   Dependencies: logging only
   Extract Second: Yes (pure function, reusable)

3. fetch_and_convert_prices()
   Lines: 222-268 (47 lines)
   Complexity: MEDIUM
   Purpose: Get prices and convert to USD
   Inputs: current_date, stock_amounts, portfolio_data, exchange rates
   Outputs: current_prices, cached exchange rates
   Dependencies: currency_converter, logger
   Used By: Helpers 3, 5, 6, 7, 8

4. execute_initial_purchases()
   Lines: 310-337 (28 lines)
   Complexity: LOW-MEDIUM ✓
   Purpose: Execute first-day purchases
   Inputs: current_date, stock_amounts, current_prices, dca_info, shares, commission
   Outputs: trades_executed, daily_cash_inflow
   Dependencies: Helper 2 output
   Side-Effects: Modifies shares dict

5. calculate_daily_metrics_and_history()
   Lines: 650-684 (35 lines)
   Complexity: LOW-MEDIUM ✓
   Purpose: Calculate portfolio metrics and history
   Inputs: current_date, shares, prices, cash, prev_value, dca_info
   Outputs: portfolio_value, daily_return, weights_history
   Dependencies: None (uses dca_info only)
   Side-Effects: None (pure calculations)

6. detect_and_update_delisting()
   Lines: 270-307 (38 lines)
   Complexity: MEDIUM
   Purpose: Detect delisted stocks (30+ days no price)
   Inputs: current_date, stock_amounts, current_prices, dca_info
   Outputs: None (updates delisted_stocks set, last_valid_prices dict)
   Dependencies: TradingThresholds constant
   Side-Effects: Yes (modifies state dicts/sets)

7. execute_periodic_dca_purchases()
   Lines: 341-402 (62 lines)
   Complexity: HIGH
   Purpose: Execute periodic DCA purchases
   Inputs: current_date, prev_date, stock_amounts, current_prices, dca_info, shares
   Outputs: trades_executed, daily_cash_inflow
   Dependencies: get_next_nth_weekday(), get_weekday_occurrence(), FREQUENCY_MAP
   Side-Effects: Modifies dca_info, shares

8. execute_rebalancing_trades()
   Lines: 495-648 (154 lines)
   Complexity: VERY HIGH ⚠️
   Purpose: Execute rebalancing and record history
   Inputs: current_date, adjusted_target_weights, shares, prices, cash, commission
   Outputs: Dict with trades_executed, rebalance_trades, weights_before/after
   Dependencies: Helper 4 (adjusted weights), TradingThresholds
   Side-Effects: Modifies shares, cash_holdings, available_cash
   Extract Last: Yes (most complex, many dependencies)

================================================================================
MAIN LOGICAL PHASES (7 phases)
================================================================================

PHASE 1: SETUP & INITIALIZATION (Lines 115-190)
├─ Extract cash holdings
├─ Setup date range from portfolio data
├─ Load ticker currencies (batch optimized)
├─ Load exchange rates for currency conversion
└─ Calculate target weights for rebalancing

PHASE 2: VARIABLE INITIALIZATION (Lines 191-213)
└─ Initialize all tracking dictionaries/lists
   ├─ shares, portfolio_values, daily_returns
   ├─ rebalance_history, weight_history
   ├─ delisted_stocks, last_valid_prices
   └─ state tracking variables

PHASE 3: MAIN DATE LOOP (Lines 215-684) ← CORE SIMULATION ENGINE
└─ for current_date in date_range:
   ├─ 3a. Filter date range
   ├─ 3b. Fetch prices & convert to USD
   ├─ 3c. Detect delisting (30+ days no price)
   ├─ 3d. Execute initial purchases (first day)
   ├─ 3e. Execute periodic DCA purchases
   ├─ 3f. Rebalancing (if triggered)
   └─ 3g. Calculate daily metrics

PHASE 4: RESULT CREATION (Lines 686-709)
└─ Create DataFrame with results
   ├─ Portfolio_Value, Daily_Return, Cumulative_Return
   └─ Attach metadata (trades, history, weights)

================================================================================
KEY COMPLEXITY POINTS
================================================================================

HIGHEST COMPLEXITY BLOCKS:
1. Rebalancing execution (lines 495-648) - 154 lines
   ├─ Weight adjustment for delisted stocks
   ├─ Trade execution with multiple branches
   ├─ Commission scaling across portfolio
   └─ History recording

2. Periodic DCA calculation (lines 341-402) - 62 lines
   ├─ Nth Weekday schedule computation
   ├─ Execution count tracking
   └─ Next schedule calculation

3. Price conversion with fallback (lines 222-268) - 47 lines
   ├─ Multiple exchange rate sources
   ├─ Fallback cache for missing data
   └─ Currency conversion multiplier

NESTED LOOP STRUCTURE:
Main Loop: for current_date in date_range
├─ Loop 1: for unique_key in stock_amounts [prices]        O(m)
├─ Loop 2: for unique_key in stock_amounts [delisting]     O(m)
├─ Loop 3: for unique_key in stock_amounts [initial]       O(m), first day
├─ Loop 4: for symbol in stock_amounts [DCA check]         O(m)
└─ Loop 5: for unique_key, target in weights [trades]      O(m), complex

TIME COMPLEXITY: O(n × m) where n = days, m = stocks

================================================================================
REFACTORING IMPACT
================================================================================

BEFORE:
├─ Single function: 625 lines
├─ Cyclomatic complexity: 10+
├─ Max nesting depth: 4 levels
├─ Test approach: Full integration test only
└─ Code reusability: None

AFTER (proposed):
├─ Main function: ~150 lines
├─ Helper functions: 8 focused functions (avg 53 lines)
├─ Cyclomatic complexity: 3-4 (per function)
├─ Max nesting depth: 2 levels
├─ Test approach: 8 unit tests + 1 integration test
└─ Code reusability: Each helper can be tested/used independently

QUALITY IMPROVEMENTS:
├─ Readability: Highly nested → Clear function names
├─ Testability: Integration-only → Unit + integration tests
├─ Maintainability: Single point of change → Isolated modifications
├─ Performance: Same O(n×m) complexity
└─ Debugging: Full trace → Isolated function traces

================================================================================
CRITICAL DEPENDENCIES & CONSTRAINTS
================================================================================

EXECUTION ORDER (must be maintained):
1. SETUP PHASE must complete before DATE LOOP
2. PRICE FETCHING (Helper 2) must execute before all others in loop
3. DELISTING DETECTION must execute before REBALANCING
4. INITIAL PURCHASE must set shares before REBALANCING
5. PERIODIC DCA must complete before REBALANCING calculation
6. REBALANCING must complete before DAILY METRICS
7. DAILY METRICS must accumulate to lists in loop

MUTABLE STATE PATTERN:
├─ Helper 2 (prices): Returns new dict (no modification)
├─ Helper 3 (delisting): Modifies delisted_stocks, last_valid_prices
├─ Helper 4 (weights): Returns new dict (pure function)
├─ Helper 5 (initial): Modifies shares dict
├─ Helper 6 (DCA): Modifies dca_info, shares
├─ Helper 7 (rebalancing): Modifies shares, cash_holdings
└─ Helper 8 (metrics): Pure calculations, no modification

ASYNC/THREADING NOTES:
├─ Phase 1 setup already uses asyncio.to_thread()
├─ Helpers 2-8 are synchronous (no async needed)
├─ Could parallelize currency conversion in Helper 2
└─ Must maintain atomic transaction boundaries

================================================================================
DOCUMENTS PROVIDED
================================================================================

1. REFACTORING_ANALYSIS.md
   └─ Comprehensive analysis of function structure
      ├─ 7 main logical phases
      ├─ Loop structures and nesting
      ├─ Nested logic blocks
      └─ 8 extraction candidates with details

2. EXTRACTION_CANDIDATES.md
   └─ Detailed specifications for 8 helpers
      ├─ Function specifications with full signatures
      ├─ Input/output types
      ├─ Complexity analysis
      ├─ Key logic for each function
      ├─ Architectural patterns
      └─ Extraction order

3. FUNCTION_STRUCTURE_DIAGRAM.md
   └─ Visual ASCII diagrams
      ├─ Overall function flow
      ├─ Main date loop breakdown
      ├─ Rebalancing logic flow
      ├─ Loop nesting structure
      ├─ Dependency graph
      ├─ Complexity comparison
      └─ Key decision points

4. EXTRACTION_QUICK_REFERENCE.txt (this file)
   └─ Quick lookup for all information

================================================================================
RECOMMENDED NEXT STEPS
================================================================================

PHASE 1: Preparatory (no code changes)
├─ [ ] Review all three analysis documents
├─ [ ] Identify potential blockers in extraction
└─ [ ] Create test scaffolding

PHASE 2: Extract in order (one helper at a time)
├─ [ ] Extract Helper 1: initialize_portfolio_state()
├─ [ ] Extract Helper 4: calculate_adjusted_rebalance_weights()
├─ [ ] Extract Helper 2: fetch_and_convert_prices()
├─ [ ] Extract Helper 5: execute_initial_purchases()
├─ [ ] Extract Helper 8: calculate_daily_metrics_and_history()
├─ [ ] Extract Helper 3: detect_and_update_delisting()
├─ [ ] Extract Helper 6: execute_periodic_dca_purchases()
└─ [ ] Extract Helper 7: execute_rebalancing_trades()

PHASE 3: Testing & Verification
├─ [ ] Unit test each extracted helper
├─ [ ] Integration test refactored main function
├─ [ ] Verify output DataFrame matches original
├─ [ ] Performance comparison
└─ [ ] Code review

PHASE 4: Cleanup
├─ [ ] Remove obsolete code
├─ [ ] Update documentation
├─ [ ] Run full test suite
└─ [ ] Deploy to staging

================================================================================
